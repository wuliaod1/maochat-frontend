<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaoChat</title>

    <meta name="theme-color" content="#392d5a"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <style>
        /* CSSæ ·å¼ä»£ç ä¸ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒ... */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root {--primary-color: rgba(140, 69, 252, 0.7);--primary-hover: rgba(140, 69, 252, 0.9);--dark-glass: rgba(35, 35, 45, 0.65);--light-glass: rgba(255, 255, 255, 0.1);--border-color: rgba(255, 255, 255, 0.125);--text-color: #f0f0f0;--placeholder-color: rgba(255, 255, 255, 0.6);}
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {font-family: 'Poppins', sans-serif;height: 100vh;width: 100vw;overflow: hidden;color: var(--text-color);background: linear-gradient(145deg, #1c2039 0%, #392d5a 50%, #683a54 100%);background-attachment: fixed;display: flex;justify-content: center;align-items: center;}
        .glass-container {background: var(--dark-glass);backdrop-filter: blur(12px) saturate(180%);-webkit-backdrop-filter: blur(12px) saturate(180%);border-radius: 20px;border: 1px solid var(--border-color);box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);padding: 30px;}
        .auth-view {width: 380px;display: none;flex-direction: column;gap: 20px;}
        .auth-view h2 { text-align: center; font-weight: 300; letter-spacing: 2px; margin-bottom: 10px; }
        .input-group input {width: 100%;background: var(--light-glass);border: 1px solid var(--border-color);border-radius: 8px;padding: 12px;color: var(--text-color);font-size: 16px;outline: none;transition: all 0.2s;}
        .input-group input::placeholder { color: var(--placeholder-color); }
        .input-group input:focus { border-color: rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
        .glass-button {background: var(--primary-color);color: #fff;border: none;border-radius: 8px;padding: 12px;font-size: 18px;cursor: pointer;transition: all 0.3s ease;font-weight: 600;}
        .glass-button:hover { background: var(--primary-hover); box-shadow: 0 0 20px rgba(140, 69, 252, 0.4); }
        .form-link { color: #ccc; text-decoration: none; text-align: center; margin-top: 10px; cursor: pointer; transition: color 0.2s; }
        .form-link:hover { color: #fff; }
        .error-message { color: #ff8a8a; text-align: center; min-height: 20px; }
        #chat-view {display: none;width: 90vw;height: 90vh;max-width: 1400px;padding: 0;flex-direction: row;}
        .sidebar {width: 30%;min-width: 320px;height: 100%;display: flex;flex-direction: column;padding: 20px;border-right: 1px solid var(--border-color);}
        .main-chat {width: 70%;height: 100%;display: flex;flex-direction: column;}
        .sidebar-section { padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .sidebar-section:last-child { border-bottom: none; }
        .sidebar-section h4 { margin-bottom: 10px; font-weight: 400; color: #ccc; }
        .user-info .username { font-size: 1.2em; margin-bottom: 15px; }
        .friend-list { flex-grow: 1; overflow-y: auto; }
        .friend-item, .request-item, .search-item {display: flex; justify-content: space-between; align-items: center;padding: 12px 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s;}
        .friend-item:hover { background: var(--light-glass); }
        .friend-item.active { background: rgba(140, 69, 252, 0.3); }
        .friend-name { display: flex; align-items: center; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; margin-right: 10px; background: #9e9e9e; }
        .status-dot.online { background: #4caf50; }
        .action-buttons button {background: none; border: 1px solid var(--border-color); color: #fff;width: 30px; height: 30px; border-radius: 50%; cursor: pointer;margin-left: 5px; transition: background 0.2s;}
        .action-buttons button:hover { background: var(--light-glass); }
        .action-buttons button.accept:hover { background: #4caf50; }
        .action-buttons button.reject:hover { background: #f44336; }
        .chat-header {padding: 15px 20px; text-align: center;display: flex; align-items: center; justify-content: center; position: relative;border-bottom: 1px solid var(--border-color);}
        #back-to-sidebar-button {display: none;position: absolute;left: 15px;font-size: 1.5em;background: none;border: none;color: #fff;cursor: pointer;}
        .chat-messages {flex-grow: 1; padding: 20px; overflow-y: auto;display: flex; flex-direction: column; gap: 15px;}
        .message-bubble { padding: 10px 15px; border-radius: 18px; max-width: 65%; word-wrap: break-word; }
        .message-bubble.sent { background: var(--primary-color); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message-bubble.received { background: #3e404d; align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-status { font-size: 0.7em; text-align: right; color: #ccc; align-self: flex-end; margin: 2px 5px 0 0; }
        .chat-input-area { padding: 20px; border-top: 1px solid var(--border-color); }
        .chat-input-area form { display: flex; gap: 10px; }
        .chat-input-area input { flex-grow: 1; }
        .chat-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; font-size: 1.5em; color: #666; text-align: center; }
        
        /* --- æ–°å¢ï¼šè‡ªå®šä¹‰å®‰è£…æŒ‰é’®æ ·å¼ --- */
        #install-pwa-button {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(45deg, #f957b4, #7349fb);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease-out;
        }
        #install-pwa-button:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .auth-view { width: 90vw; }
            #chat-view {position: relative;overflow: hidden;flex-direction: column;width: 100vw;height: 100vh;border-radius: 0;}
            .sidebar, .main-chat {width: 100%;height: 100%;position: absolute;top: 0;left: 0;transition: transform 0.35s ease-in-out;border-radius: 0;border-right: none;}
            .sidebar { transform: translateX(0); z-index: 10; }
            .main-chat { transform: translateX(100%); z-index: 20; }
            #chat-view.mobile-chat-active .sidebar { transform: translateX(-100%); }
            #chat-view.mobile-chat-active .main-chat { transform: translateX(0); }
            #back-to-sidebar-button { display: block; }
            .chat-header h3 { margin: 0 auto; }
            .message-bubble { max-width: 80%; }
        }
    </style>
</head>
<body>
    <!-- HTMLç»“æ„... -->
    <div id="login-view" class="glass-container auth-view"><h2>ç™»å½• MaoChat</h2><div id="login-error" class="error-message"></div><form id="login-form"><div class="input-group"><input type="text" id="login-username" placeholder="ç”¨æˆ·å" required></div><div class="input-group"><input type="password" id="login-password" placeholder="å¯†ç " required></div><button type="submit" class="glass-button">ç™» å½•</button></form><a id="show-register" class="form-link">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿå»æ³¨å†Œ</a></div><div id="register-view" class="glass-container auth-view"><h2>åˆ›å»ºæ–°è´¦æˆ·</h2><div id="register-error" class="error-message"></div><form id="register-form"><div class="input-group"><input type="text" id="register-username" placeholder="ç”¨æˆ·å" required></div><div class="input-group"><input type="password" id="register-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" required></div><button type="submit" class="glass-button">æ³¨ å†Œ</button></form><a id="show-login" class="form-link">å·²ç»æœ‰è´¦æˆ·äº†ï¼Ÿå»ç™»å½•</a></div><div id="chat-view" class="glass-container"><aside class="sidebar"><section class="sidebar-section user-info"><h3 class="username" id="current-username">ä½ å¥½, User</h3><button id="logout-button" class="glass-button" style="background: rgba(244, 67, 54, 0.6);">é€€å‡ºç™»å½•</button></section><section class="sidebar-section"><h4>æ·»åŠ å¥½å‹</h4><form id="search-form" style="display: flex; gap: 5px;"><input type="text" id="search-input" placeholder="æœç´¢ç”¨æˆ·å..." style="flex-grow:1;"><button type="submit" class="glass-button" style="padding: 10px 15px;">ğŸ”</button></form><div id="search-results"></div></section><section class="sidebar-section"><h4>å¥½å‹è¯·æ±‚</h4><div id="friend-requests"></div></section><section class="sidebar-section friend-list"><h4>å¥½å‹åˆ—è¡¨</h4><div id="friends-list-container"></div></section></aside><main id="main-chat" class="main-chat"><div id="chat-placeholder" class="chat-placeholder"><p>é€‰æ‹©ä¸€ä¸ªå¥½å‹<br>å¼€å§‹èŠå¤©å§ï¼</p></div><div id="chat-window-content" style="display: none; height: 100%; flex-direction: column;"><header id="chat-header" class="chat-header"><button id="back-to-sidebar-button"><</button><h3>Friend Name</h3></header><div id="chat-messages" class="chat-messages"></div><div class="chat-input-area"><form id="message-form"><input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off"><button type="submit" class="glass-button">å‘é€</button></form></div></div></main></div>

    <!-- æ–°å¢ï¼šè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’® -->
    <button id="install-pwa-button">å®‰è£…åº”ç”¨</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- æ–°å¢ï¼šPWAå®‰è£…æç¤ºé€»è¾‘ ---
            let deferredPrompt;
            const installButton = document.getElementById('install-pwa-button');

            window.addEventListener('beforeinstallprompt', (e) => {
                // é˜»æ­¢Chrome 67åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
                e.preventDefault();
                // å­˜å‚¨äº‹ä»¶ï¼Œä»¥ä¾¿ç¨åè§¦å‘
                deferredPrompt = e;
                // æ˜¾ç¤ºæˆ‘ä»¬è‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
                installButton.style.display = 'block';
                console.log('`beforeinstallprompt` äº‹ä»¶å·²è§¦å‘ï¼Œå®‰è£…æŒ‰é’®å·²æ˜¾ç¤ºã€‚');
            });

            installButton.addEventListener('click', async () => {
                // éšè—æˆ‘ä»¬çš„è‡ªå®šä¹‰æŒ‰é’®
                installButton.style.display = 'none';
                // æ˜¾ç¤ºå®‰è£…æç¤º
                deferredPrompt.prompt();
                // ç­‰å¾…ç”¨æˆ·çš„å“åº”
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ç”¨æˆ·å¯¹å®‰è£…æç¤ºçš„å“åº”: ${outcome}`);
                // æˆ‘ä»¬åªèƒ½ä½¿ç”¨ä¸€æ¬¡æç¤ºï¼Œæ‰€ä»¥æ¸…ç©ºå®ƒ
                deferredPrompt = null;
            });

            window.addEventListener('appinstalled', () => {
                // éšè—å®‰è£…æŒ‰é’®ï¼Œå› ä¸ºåº”ç”¨å·²ç»å®‰è£…äº†
                installButton.style.display = 'none';
                deferredPrompt = null;
                console.log('PWA å·²æˆåŠŸå®‰è£…ï¼');
            });


            // --- å…¶ä»–æ‰€æœ‰JSä»£ç ä¿æŒä¸å˜ ---
            const API_BASE_URL = 'https://www.maochat.dpdns.org';let state = { token: localStorage.getItem('token'), user: JSON.parse(localStorage.getItem('user')), socket: null, friends: [], onlineUsers: [], friendRequests: [], currentChat: null, messages: [] };const views = { login: document.getElementById('login-view'), register: document.getElementById('register-view'), chat: document.getElementById('chat-view') };const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form'), chatView = document.getElementById('chat-view');const showView = (viewName) => { Object.values(views).forEach(v => v.style.display = 'none'); views[viewName].style.display = 'flex'; };const api = axios.create({ baseURL: API_BASE_URL, headers: { 'Content-Type': 'application/json' } });api.interceptors.request.use(config => { if (state.token) config.headers['Authorization'] = `Bearer ${state.token}`; return config; });function urlBase64ToUint8Array(base64String) {const padding = '='.repeat((4 - base64String.length % 4) % 4);const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');const rawData = window.atob(base64);const outputArray = new Uint8Array(rawData.length);for (let i = 0; i < rawData.length; ++i) {outputArray[i] = rawData.charCodeAt(i);}return outputArray;}
            const subscribeToPushNotifications = async () => {try {const registration = await navigator.serviceWorker.ready;let subscription = await registration.pushManager.getSubscription();if (subscription) {console.log('ç”¨æˆ·å·²ç»è®¢é˜…ã€‚');return;}const response = await api.get('/api/users/vapid-public-key');const vapidPublicKey = response.data;if (!vapidPublicKey) {console.error('æœªèƒ½ä»æœåŠ¡å™¨è·å–VAPIDå…¬é’¥ã€‚');return;}const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);subscription = await registration.pushManager.subscribe({userVisibleOnly: true,applicationServerKey: convertedVapidKey});await api.post('/api/users/save-subscription', subscription);console.log('æ¨é€é€šçŸ¥è®¢é˜…æˆåŠŸå¹¶å·²å‘é€åˆ°åç«¯ã€‚');} catch (error) {console.error('è®¢é˜…æ¨é€é€šçŸ¥å¤±è´¥:', error);}};
            const initializeChat = async () => {showView('chat');document.getElementById('current-username').textContent = `ä½ å¥½, ${state.user.username}`;connectSocket();await fetchData();if ('serviceWorker' in navigator && 'PushManager' in window) {Notification.requestPermission().then(permission => {if (permission === 'granted') {console.log('é€šçŸ¥æƒé™å·²è·å–ï¼Œå¼€å§‹è®¢é˜…...');subscribeToPushNotifications();}});}};
            const renderFriendList = () => { const container = document.getElementById('friends-list-container'); container.innerHTML = ''; state.friends.forEach(friend => { const isOnline = state.onlineUsers.includes(friend._id), isActive = state.currentChat?._id === friend._id; const item = document.createElement('div'); item.className = `friend-item ${isActive ? 'active' : ''}`; item.innerHTML = `<div class="friend-name"><span class="status-dot ${isOnline ? 'online' : ''}"></span><span>${friend.username}</span></div>`; item.onclick = () => selectChat(friend); container.appendChild(item); }); };const renderFriendRequests = () => { const container = document.getElementById('friend-requests'); container.innerHTML = ''; state.friendRequests.forEach(req => { const item = document.createElement('div'); item.className = 'request-item'; item.innerHTML = `<span>${req.username}</span><div class="action-buttons"><button class="accept" data-id="${req.userId}">âœ“</button><button class="reject" data-id="${req.userId}">Ã—</button></div>`; container.appendChild(item); }); };const renderSearchResults = (results) => { const container = document.getElementById('search-results'); container.innerHTML = '<h4>æœç´¢ç»“æœ</h4>'; results.forEach(u => { const item = document.createElement('div'); item.className = 'search-item'; item.innerHTML = `<span>${u.username}</span><div class="action-buttons"><button class="add" data-id="${u._id}">+</button></div>`; container.appendChild(item); }); };const renderMessages = () => { const container = document.getElementById('chat-messages'); container.innerHTML = ''; state.messages.forEach(msg => { const isSent = msg.sender === state.user.id; const bubble = document.createElement('div'); bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`; bubble.textContent = msg.content; container.appendChild(bubble); if (isSent) { const statusDiv = document.createElement('div'); statusDiv.className = 'message-status'; statusDiv.textContent = msg.status || 'sent'; container.appendChild(statusDiv); } }); container.scrollTop = container.scrollHeight; };const handleLogin = async (username, password) => { try { const res = await api.post('/api/users/login', { username, password }); state.token = res.data.token; state.user = { id: res.data._id, username: res.data.username }; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); await initializeChat(); } catch (err) { document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚'; } };const handleRegister = async (username, password) => { if (password.length < 6) { document.getElementById('register-error').textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä½ã€‚'; return; } try { const res = await api.post('/api/users/register', { username, password }); state.token = res.data.token; state.user = { id: res.data._id, username: res.data.username }; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); await initializeChat(); } catch (err) { document.getElementById('register-error').textContent = 'ç”¨æˆ·åå·²å­˜åœ¨æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚'; } };const handleLogout = () => { localStorage.clear(); if(state.socket) state.socket.disconnect(); state = { token: null, user: null, socket: null, friends: [], onlineUsers: [], friendRequests: [], currentChat: null, messages: [] }; showView('login'); chatView.classList.remove('mobile-chat-active'); };const connectSocket = () => { if (state.socket) state.socket.disconnect(); state.socket = io(API_BASE_URL); state.socket.on('connect', () => state.socket.emit('go-online', state.user.id)); state.socket.on('online-users-list', (users) => { state.onlineUsers = users; renderFriendList(); }); state.socket.on('receive-message', (message) => { if (state.currentChat && message.sender === state.currentChat._id) { state.messages.push(message); renderMessages(); state.socket.emit('message-read', { messageId: message._id }); } }); state.socket.on('message-status-update', ({ messageId, status }) => { const msg = state.messages.find(m => m._id === messageId); if (msg) { msg.status = status; renderMessages(); } }); };const fetchData = async () => { try { const [friendsRes, requestsRes] = await Promise.all([api.get('/api/users/friends'), api.get('/api/users/friend-requests')]); state.friends = friendsRes.data; state.friendRequests = requestsRes.data; renderFriendList(); renderFriendRequests(); } catch (error) { if (error.response?.status === 401) handleLogout(); } };const selectChat = async (friend) => { state.currentChat = friend; renderFriendList(); document.getElementById('chat-placeholder').style.display = 'none'; document.getElementById('chat-window-content').style.display = 'flex'; document.querySelector('#chat-header h3').textContent = friend.username; if (window.innerWidth <= 768) { chatView.classList.add('mobile-chat-active'); } try { const res = await api.get(`/api/users/chat-history/${friend._id}`); state.messages = res.data; renderMessages(); } catch (error) { console.error('è·å–èŠå¤©è®°å½•å¤±è´¥', error); } };
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('login-username').value, document.getElementById('login-password').value); });registerForm.addEventListener('submit', (e) => { e.preventDefault(); handleRegister(document.getElementById('register-username').value, document.getElementById('register-password').value); });document.getElementById('show-register').onclick = () => showView('register');document.getElementById('show-login').onclick = () => showView('login');document.getElementById('logout-button').onclick = handleLogout;document.getElementById('back-to-sidebar-button').onclick = () => { chatView.classList.remove('mobile-chat-active');};document.getElementById('search-form').addEventListener('submit', async (e) => { e.preventDefault(); const searchTerm = document.getElementById('search-input').value; if (!searchTerm) return; try { const res = await api.get(`/api/users/search?q=${searchTerm}`); renderSearchResults(res.data); } catch (error) { console.error(error); }});document.getElementById('search-results').addEventListener('click', async (e) => { if(e.target.classList.contains('add')) { const recipientId = e.target.dataset.id; try { await api.post('/api/users/friend-request', { recipientId }); alert('å¥½å‹è¯·æ±‚å·²å‘é€'); document.getElementById('search-results').innerHTML = ''; } catch (err) { alert(err.response?.data?.message || 'å‘é€å¤±è´¥'); }}});document.getElementById('friend-requests').addEventListener('click', async (e) => { if(e.target.matches('button')) { const senderId = e.target.dataset.id; const accept = e.target.classList.contains('accept'); try { await api.post('/api/users/friend-request/respond', { senderId, accept }); await fetchData(); } catch (err) { alert(err.response?.data?.message || 'æ“ä½œå¤±è´¥'); }}});document.getElementById('message-form').addEventListener('submit', (e) => { e.preventDefault(); const messageInput = document.getElementById('message-input'); const content = messageInput.value; if (!content || !state.currentChat) return; const messageData = { senderId: state.user.id, receiverId: state.currentChat._id, content: content }; state.socket.emit('private-message', messageData); state.messages.push({ ...messageData, _id: Date.now().toString(), sender: state.user.id, status: 'sending...' }); renderMessages(); messageInput.value = '';});
            if ('serviceWorker' in navigator) {window.addEventListener('load', () => {navigator.serviceWorker.register('./service-worker.js').then(registration => console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope)).catch(error => console.log('ServiceWorker æ³¨å†Œå¤±è´¥: ', error));});}
            if (state.token && state.user) {initializeChat();} else {showView('login');}
        });
    </script>
</body>
</html>                    }
                    
                    const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
                    
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedVapidKey
                    });
                    
                    await api.post('/api/users/save-subscription', subscription);
                    console.log('æ¨é€é€šçŸ¥è®¢é˜…æˆåŠŸå¹¶å·²å‘é€åˆ°åç«¯ã€‚');

                } catch (error) {
                    console.error('è®¢é˜…æ¨é€é€šçŸ¥å¤±è´¥:', error);
                }
            };
            
            // --- ä¿®æ”¹ï¼šåˆå§‹åŒ–èŠå¤©å‡½æ•° ---
            const initializeChat = async () => {
                showView('chat');
                document.getElementById('current-username').textContent = `ä½ å¥½, ${state.user.username}`;
                connectSocket();
                await fetchData();

                // åœ¨åˆå§‹åŒ–æ—¶ï¼Œè¯·æ±‚æƒé™å¹¶è®¢é˜…
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('é€šçŸ¥æƒé™å·²è·å–ï¼Œå¼€å§‹è®¢é˜…...');
                            subscribeToPushNotifications();
                        } else {
                            console.log('ç”¨æˆ·æ‹’ç»äº†é€šçŸ¥æƒé™ã€‚');
                        }
                    });
                }
            };

            // --- å…¶ä»–JSå‡½æ•° (æ— é‡å¤§å˜åŒ–) ---
            const renderFriendList = () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ const container = document.getElementById('friends-list-container'); container.innerHTML = ''; state.friends.forEach(friend => { const isOnline = state.onlineUsers.includes(friend._id), isActive = state.currentChat?._id === friend._id; const item = document.createElement('div'); item.className = `friend-item ${isActive ? 'active' : ''}`; item.innerHTML = `<div class="friend-name"><span class="status-dot ${isOnline ? 'online' : ''}"></span><span>${friend.username}</span></div>`; item.onclick = () => selectChat(friend); container.appendChild(item); }); };
            const renderFriendRequests = () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ const container = document.getElementById('friend-requests'); container.innerHTML = ''; state.friendRequests.forEach(req => { const item = document.createElement('div'); item.className = 'request-item'; item.innerHTML = `<span>${req.username}</span><div class="action-buttons"><button class="accept" data-id="${req.userId}">âœ“</button><button class="reject" data-id="${req.userId}">Ã—</button></div>`; container.appendChild(item); }); };
            const renderSearchResults = (results) => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ const container = document.getElementById('search-results'); container.innerHTML = '<h4>æœç´¢ç»“æœ</h4>'; results.forEach(u => { const item = document.createElement('div'); item.className = 'search-item'; item.innerHTML = `<span>${u.username}</span><div class="action-buttons"><button class="add" data-id="${u._id}">+</button></div>`; container.appendChild(item); }); };
            const renderMessages = () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ const container = document.getElementById('chat-messages'); container.innerHTML = ''; state.messages.forEach(msg => { const isSent = msg.sender === state.user.id; const bubble = document.createElement('div'); bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`; bubble.textContent = msg.content; container.appendChild(bubble); if (isSent) { const statusDiv = document.createElement('div'); statusDiv.className = 'message-status'; statusDiv.textContent = msg.status || 'sent'; container.appendChild(statusDiv); } }); container.scrollTop = container.scrollHeight; };
            const handleLogin = async (username, password) => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ try { const res = await api.post('/api/users/login', { username, password }); state.token = res.data.token; state.user = { id: res.data._id, username: res.data.username }; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); await initializeChat(); } catch (err) { document.getElementById('login-error').textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚'; } };
            const handleRegister = async (username, password) => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ if (password.length < 6) { document.getElementById('register-error').textContent = 'å¯†ç è‡³å°‘éœ€è¦6ä½ã€‚'; return; } try { const res = await api.post('/api/users/register', { username, password }); state.token = res.data.token; state.user = { id: res.data._id, username: res.data.username }; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); await initializeChat(); } catch (err) { document.getElementById('register-error').textContent = 'ç”¨æˆ·åå·²å­˜åœ¨æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚'; } };
            const handleLogout = () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ localStorage.clear(); if(state.socket) state.socket.disconnect(); state = { token: null, user: null, socket: null, friends: [], onlineUsers: [], friendRequests: [], currentChat: null, messages: [] }; showView('login'); chatView.classList.remove('mobile-chat-active'); };
            const connectSocket = () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ if (state.socket) state.socket.disconnect(); state.socket = io(API_BASE_URL); state.socket.on('connect', () => state.socket.emit('go-online', state.user.id)); state.socket.on('online-users-list', (users) => { state.onlineUsers = users; renderFriendList(); }); state.socket.on('receive-message', (message) => { if (state.currentChat && message.sender === state.currentChat._id) { state.messages.push(message); renderMessages(); state.socket.emit('message-read', { messageId: message._id }); } }); state.socket.on('message-status-update', ({ messageId, status }) => { const msg = state.messages.find(m => m._id === messageId); if (msg) { msg.status = status; renderMessages(); } }); };
            const fetchData = async () => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ try { const [friendsRes, requestsRes] = await Promise.all([api.get('/api/users/friends'), api.get('/api/users/friend-requests')]); state.friends = friendsRes.data; state.friendRequests = requestsRes.data; renderFriendList(); renderFriendRequests(); } catch (error) { if (error.response?.status === 401) handleLogout(); } };
            const selectChat = async (friend) => { /* ... æ­¤å¤„ä»£ç æ— å˜åŒ– ... */ state.currentChat = friend; renderFriendList(); document.getElementById('chat-placeholder').style.display = 'none'; document.getElementById('chat-window-content').style.display = 'flex'; document.querySelector('#chat-header h3').textContent = friend.username; if (window.innerWidth <= 768) { chatView.classList.add('mobile-chat-active'); } try { const res = await api.get(`/api/users/chat-history/${friend._id}`); state.messages = res.data; renderMessages(); } catch (error) { console.error('è·å–èŠå¤©è®°å½•å¤±è´¥', error); } };
            
            // --- äº‹ä»¶ç›‘å¬å™¨ (æœ€åå¢åŠ Service Workeræ³¨å†Œ) ---
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('login-username').value, document.getElementById('login-password').value); });
            registerForm.addEventListener('submit', (e) => { e.preventDefault(); handleRegister(document.getElementById('register-username').value, document.getElementById('register-password').value); });
            document.getElementById('show-register').onclick = () => showView('register');
            document.getElementById('show-login').onclick = () => showView('login');
            document.getElementById('logout-button').onclick = handleLogout;
            document.getElementById('back-to-sidebar-button').onclick = () => { chatView.classList.remove('mobile-chat-active');};
            document.getElementById('search-form').addEventListener('submit', async (e) => { e.preventDefault(); const searchTerm = document.getElementById('search-input').value; if (!searchTerm) return; try { const res = await api.get(`/api/users/search?q=${searchTerm}`); renderSearchResults(res.data); } catch (error) { console.error(error); }});
            document.getElementById('search-results').addEventListener('click', async (e) => { if(e.target.classList.contains('add')) { const recipientId = e.target.dataset.id; try { await api.post('/api/users/friend-request', { recipientId }); alert('å¥½å‹è¯·æ±‚å·²å‘é€'); document.getElementById('search-results').innerHTML = ''; } catch (err) { alert(err.response?.data?.message || 'å‘é€å¤±è´¥'); }}});
            document.getElementById('friend-requests').addEventListener('click', async (e) => { if(e.target.matches('button')) { const senderId = e.target.dataset.id; const accept = e.target.classList.contains('accept'); try { await api.post('/api/users/friend-request/respond', { senderId, accept }); await fetchData(); } catch (err) { alert(err.response?.data?.message || 'æ“ä½œå¤±è´¥'); }}});
            document.getElementById('message-form').addEventListener('submit', (e) => { e.preventDefault(); const messageInput = document.getElementById('message-input'); const content = messageInput.value; if (!content || !state.currentChat) return; const messageData = { senderId: state.user.id, receiverId: state.currentChat._id, content: content }; state.socket.emit('private-message', messageData); state.messages.push({ ...messageData, _id: Date.now().toString(), sender: state.user.id, status: 'sending...' }); renderMessages(); messageInput.value = '';});

            // --- ä¿®æ”¹ï¼šåˆå§‹åŒ–æ—¶æ³¨å†ŒService Worker ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope))
                        .catch(error => console.log('ServiceWorker æ³¨å†Œå¤±è´¥: ', error));
                });
            }

            // --- åº”ç”¨å¯åŠ¨ ---
            if (state.token && state.user) {
                initializeChat();
            } else {
                showView('login');
            }
        });
    </script>
</body>
</html>
